\newcommand{\todo}[1]{{\em \textcolor{red}{ #1}}}
\newcommand{\beq}{\begin{equation}}
\newcommand{\eeq}{\end{equation}}
\newcommand{\lang}{\langle}
\newcommand{\ra}{\rangle}
\newcommand{\vep}{\bm{\epsilon}}
\newcommand{\ep}{\epsilon}
\newcommand{\pars}{\vec{\theta}}
\newcommand{\dev}{\mathrm{d}}
\newcommand{\mstar}{h^{-1}M_\odot}
\newcommand{\hst}{\project{HST}}
\newcommand{\wfc}{\project{WFC3}}

\chapter{Super-resolution PSF model of HST WFC3-IR\chaplabel{wfc3ir}}

This \paper is joint work with Ross~Fadely (Insight) and David~W.~Hogg (NYU) and it is being prepared for submission. 

\section{Chapter abstract}

Accurate model of the Point Spread Function is crucial for reliable point source photometry, astrometry, and weak lensing studies.
The PSF model of the $\hst$ $\wfc$ IR channel does not meet the accuracy required by these science goals. In addition, the PSF of the $\hst$ $\wfc$ IR 
channel is poorly sampled. Weak lensing studies of poorly resolved images of faint distant galaxies demands 
a great knowledge of the PSF sampled at a resolution higher than of the $\hst$ $\wfc$ pixels.
In this investigation, we present a generative model of every image taken by the $\wfc$ IR channel as a set of a number of point sources convolved
with the instrument PSF. In particular, we focus on modeling the pixel-convolved PSF, the instrument PSF convolved with the pixel response function. 
In particular, we model the images of point sources observed in the calibration program of the $\hst$ $\wfc$ IR channel in the F160W bandpass. We 
expect the inference of the super-resolution PSF in the other bandpasses of the IR channel to follow a simillar procedure. 
We find that we can find th optimal soution of the problem by using a variance model that correctly takes into account the model 
uncertainty and a regularization term that imposes a smoothness condition on the super-resolution PSF 

\section{Introduction}

The Point Spread Function (hereafter PSF) determines the fraction of photons from a given point source that lands on a particular location 
from the center of that point source on a detector. The PSF of the $\hst$ $\wfc$ camera is extremely undersampled. That is, if a center of an observed star lies 
on the center of a pixel, a significant fraction of the brightness of that star will be 
encapsulated by the detector's pixel that contains the centroid of the star.
In other words, the full-width half-maximum (FWHM) of the PSF is not spanned by multiple pixels since the designed 
pixels are large. This is mainly the result of a compromise made in design of the detectors to cover a wider field of view.

Poor sampling of the PSF by detectors renders many astronomical image processing tasks difficult. Precise astrometry and photometry 
of individual point sources requires knowledge of the PSF sampled on higher resolution than that of the detector pixels. 
In uncalibrated observations, the images of stars are generated by convolution of the point sources with the PSF and multiplication 
with a non-uniform detector sensitivity called the \emph{flat-field}. Flat-field corrections are important for photometry and astrometry of 
individual point sources. In under-sampled images, capturing the sub-pixel variations of the flat-field requires having a higher resolution 
model of the PSF. 

Furthermore, cosmic shear studies require accurate measurement of the shapes of individual distant galaxies. The galaxies used for estimation 
of the cosmic shear signal are faint and barely resolved by the $\hst$ $\wfc$ detectors. In order to reliably estimate the ellipticities of these poorly 
resolved galaxies through model fitting, we need to convolve the model describing the light distribution of these galaxies with a higher resolution PSF model. 
Therfore, having access to a higher resolution model of the PSF is an essential ingredient in weak lensing studies of galaxies detected by the $\hst$ $\wfc$ IR 
channel.   

In this investigation, we focus on modeling the pixel-convolved PSF which is the optical (instrumental) PSF convolved with the 
pixel response function. It is the pixel-convolved PSF that can be directly estimated from observation without making any assumption 
about the sensitivity of detector pixels. Moreover, it is the pixel-convolved PSF that can be used to perform astrometry and photometry measurements as well as 
galaxy shape measurement for weak lensing analyses. All these procedures involve fitting a model to the pixel-convolved PSF. 

Alternatively, one can deliver a model of the optical (instrumental) PSF based on physical models of the telescope optics. 
This involves measurement of the optical wavefront at all locations across the focal plane and use of physically motivated parameters 
to model the image changes in wavefront. Significant progress has been made in exploring the space of physical models that can efficiently 
describe the optical PSF \citep{zernike,krist1995,krist2011,galsim_software}. 

Development of the optical models of the PSF are valuable efforts for simulations, validations, and understanding the systematic uncertainties 
that can affect astronomical inferences \citep{great3,galsim}. In practice however, using the optical PSF for photometry, astrometry and weak lensing studies 
requires fitting a star's model to the wavefront PSF model. The major drawbacks of this approach are the following: $(i)$ it does not make use of the observed 
data, and ${ii}$ it makes strong assumptions about sensitivity of detector pixels when it is used for model fitting. Since these reasons, we focus on building a 
data driven empirical model of the PSF. From now on in this \paper, we refer to the pixel-convolved PSF as the PSF. 


This \paper is structured as follows: In Section \ref{sec:data} we discuss the observations and data reduction. In Section \ref{sec:method} we discuss the algorithm we 
have developed for infering the super-resolution PSF model of the $\hst$ $\wfc$ IR channel observations. In Section \ref{sec:results} we present the preliminary results, and 
in Section{sec:summary} we summarize and conclude. 

\section{Data}\label{sec:data}

The $\wfc$ IR camera consists of four filters: F105W, F125W, F140W, F160W.
In what follows in the rest of this \paper\ we focus on modeling the images of point sources in the F160W filter of $\hst$ $\wfc$ IR channel. 
In our analysis, we make use of the FLT images that our calibrated with the recent models of charge transfer efficiency, flat-field, etc. 
We choose not use Drizzeled images \citep{drizzle,astrodrizzle} because they introduce correlated noise and 
distortions to the PSF that are not consistent across the image (a new algorithm \citep{olic} developed for the WFIRST mission does not suffer from these issues). 
This poses a challenge for optimal extraction of information and accurate measurement of shapes. Therefore the pixels in the FLT images are better-suited for performing PSF modeling. 

For each FLT image, we follow the following procedure to select stars with sufficiently high signal-to-noise ratio 
for PSF mdoeling. First the Source Extractor software \citep{sextractor} is run on each image to detect the objects. 
For each object, the stellarity index and blending/error flags are extracted. An object is called a \emph{star} if no blending/error flag is 
raised, its stellarity index is greater than 0.8 and if its peak pixel brightness values is 25 times greater than the median pixel brightness 
value.  

The FLT files obtained from the HST MAST archive are accompanied by Data Quality extension files. While extracting the super-resolution PSF model 
from the point sources in FLT images, pixels with data quality other than zero are not included in the model. This requirement guarantees that 
the damaged pixels do not contribute to the PSF model. For each point source, we extract a 25 pixels $\time$ 25 pixels patch that is centered on the brightest 
pixel of the point source.   

\section{Method}\label{sec:method}

We build our empirical model of the PSF by assuming that a given point source at the center of a patch can be described by 
the following quantities: 

\begin{itemize}
\item A global solution for the super-resolution PSF $X$ that is shared between all point sources across the field of view. We assume 
that $X$ is normalized to one and it is centered at the center of the central pixel of the patch. This super-resolution PSF is sampled on 
a grid with a higher resolution that the native pixel grid of $\hst$ $\wfc$ IR observations.

\item Centroid coordinate of a point source at a given patch $\Delta_n = (\Delta x_n, \Delta y_n)$. 
These two parameters dictate the offset between the position of the centroid of the point source $n$ with 
respect to the center of the patch.

\item Flux quantity $f_n$ which is the brightness of the point source.

\item A background quantity $b_n$ which sets the brightness level of the background sky.

\end{itemize}

Given these ingredients, we write down the generative forward model of the point sources in the center of patches in the following way:

\begin{eqnarray}
\mathbf{d}_{n} &=&  \mathbf{m}_{n} + \mathrm{noise}, \\
m_{n,i} &=& f_{n}K^{(n)}_{il} (\Delta_n) X_{l} + b_{n}. 
\end{eqnarray} 

Note that the operator $K^{(n)}(\Delta_n)$ is a linear operator that maps the super-resolution psf $X$ to a downsampled PSF at the native 
data grid. That is, when this operator is applied to $X$, it samples the $X$ on a downsampled grid (with the same resolution as the observations) 
that is shifted with respect to the grid on which $X$ is defined. The shift between the two grids is given by the vector $\Delta_n = (\Delta x_n , \Delta y_n)$.

The are many possibilities for designing the sampling operator $K$. We want to be able to explicitly construct these matrices so we can analytically 
compute the likelihood function and its derivative with respect to the super-resolution PSF $X$. The simplest and fastest approach that one could 
choose is bilinear interpolation. But after applying this method to simulated PSFs, we find that this method lacks the sufficient accuracy we 
need for our forward model.

%We follow something like \citep{xd,hmf} heteroscedastic matrix factorization ....
%Simillar methods in the literature that rely on compressed sensing \citep{ngole,ngole2}

It is important to note that our forward model of the $\wfc$ IR observations suffer from significant degeneracies. The first degen

The factor by which the PSF is undersampled varies from one filter to another. Our strategy for inferring the super-resolution of the PSF model of F160W filter is as follows. 
First we run the Source Extractor algorithm to identify all the stellar sources in the observed data. 

In patch $n$, the model is given by

\begin{eqnarray}
\mathbf{y}_{n} &=&  \mathbf{m}_{n} + \mathrm{noise} \\
m_{n,i} &=& f_{n}K^{(n)}_{il} (\Delta_n) X_{l} + b_{n} 
\end{eqnarray} 
where the variance of the noise model adopted in this work is the following:
\beq
s_n^2 = \sigma_{n}^{2} + g.m_{n}
\eeq    

Ideally one would use the bright isolated sources to estimate the PSF. A considerable fraction of the observed stars are present in the crowded fields. 
In order to alleviate the issue arising from the contamination of stellar patches by the light coming from overlapping sources, we add another term to the noise model which accounts for the discrepancy between the downsampled PSF model on the data grid and the observed star. 

\beq
s_n^2 = \sigma_{n}^{2} + g.m_{n} + qm_{n}^{2}
\eeq 


The log-likelihood function for each patch is written as follows. 
\beq
-2 \ln L_{n} = \sum_{i=1}^{N_{\rm pix}} \frac{\big(y_{i} - m_{i} \big)^{2}}{s^{2}_{n}} + \ln(s_{n}^{2})
\eeq

Our strategy for finding the optimal values of the parameters of individual point sources $\{f_{n},b_{n},\Delta_{n}\}_{n=1}^{N}$ and the global solution of the
super-resolution PSF $X$ is as follows:

\begin{algorithm} 
\caption{The procedure for Inferring the Super-Resolution PSF}
\begin{algorithmic}[1] \label{alg:abcpmc}
%\STATE \DATA: D
%\STATE \RESULT: ABC posterior sample of $\pars$
\IF{$t=1:$}
%\STATE $\epsilon_t \gets \infty$
\FOR{$n=1,...,N$}
   \STATE // \emph{This can now be done in parallel for all i}
   %\WHILE{$\rho(X,D)>\epsilon_t$}
   \STATE $b_{n}$ \gets \mathrm{median} \; $(y_{n})$
   \STATE $f_{n}$ \gets $\sum_{i=1}^{N_pix} \big(y_{n,i} - b_{n}\big)$
   \STATE \mathrm{Initialize} $\Delta_{n}$ with the 3\time3 polynomial method
   \STATE $X_{n}$ \gets \mathrm{cubic \; spline} $(\Delta_n)[\big(y_{n,i} - b_{n}\big)/f_n]$
\ENDFOR
\STATE $X$ \gets $\sum_{n=1}^{N} X_{n]$
   %\ENDWHILE
\ENDIF
\IF{$t=2,...,N_{it}:$}
\FOR{$i=1,...,N$}
   \STATE // \emph{This loop can now be done in parallel for all i}
   \WHILE{$\rho(X,D)>\epsilon_t$}
   \STATE Draw $\pars^{*}_{t}$ from $\{\pars_{t-1}\}$ with probabilities $\{w_{t-1}\}$
   \STATE $\pars^{*}_{t} \gets K(\pars^{*}_{t},.)$
   \STATE $X = f(\pars^{*}_{t})$
   \ENDWHILE
   \STATE $\pars^{(i)}_{t} \gets \pars^{*}_{t}$
   \STATE $w^{(i)}_{t} \gets \pi(\pars^{(i)}_{t}) / \big(\sum\limits_{j=1}^{N}w_{t-1}^{(i)}K(\pars^{(j)}_{t-1},\pars^{(i)}_{t}) \big)$
\ENDFOR
\ENDIF
\end{algorithmic}
\end{algorithm}

\section{Preliminary Results}\label{sec:results}

blah ...

\section{Summary and Conclusion}\label{sec:summary}

blah...
